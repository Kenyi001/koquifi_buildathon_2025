<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KoquiFI - Dashboard Final</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connected {
            background: #28a745;
        }
        
        .disconnected {
            background: #dc3545;
        }
        
        .testing {
            background: #ffc107;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
            font-size: 1.5em;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .input-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 200px;
            margin-right: 10px;
        }
        
        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        #activityLog {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .debug-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="connection-status testing" id="connectionStatus">üîÑ Conectando...</div>
    
    <div class="container">
        <h1>üöÄ KoquiFI Dashboard</h1>
        
        <div class="section">
            <h3>üîç Estado de Conexi√≥n</h3>
            <div class="status-message info" id="connectionDetails">
                Iniciando diagn√≥stico de conexi√≥n...
            </div>
            <div class="debug-info" id="debugInfo"></div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Estado de Red</div>
                <div class="stat-value" id="networkStatus">Verificando...</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Cuentas Disponibles</div>
                <div class="stat-value" id="accountCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Direcci√≥n Activa</div>
                <div class="stat-value" id="activeAddress" style="font-size: 0.8em;">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Balance ETH</div>
                <div class="stat-value" id="ethBalance">-</div>
            </div>
        </div>
        
        <div class="section" id="contractSection" style="display: none;">
            <h3>üìÑ Contratos</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Total Supply KOQUI</div>
                    <div class="stat-value" id="totalSupply">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Tu Balance KOQUI</div>
                    <div class="stat-value" id="userBalance">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Tickets NFT</div>
                    <div class="stat-value" id="totalTickets">-</div>
                </div>
            </div>
        </div>
        
        <div class="section" id="actionsSection" style="display: none;">
            <h3>ü™ô Acciones</h3>
            <div class="input-group">
                <input type="number" id="mintAmount" placeholder="Cantidad" min="1" value="1000">
                <button class="button" onclick="mintTokens()">üéØ Mint</button>
                <button class="button" onclick="burnTokens()">üî• Burn</button>
            </div>
            <div class="status-message" id="actionStatus" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h3>üìä Log de Diagn√≥stico</h3>
            <div id="activityLog"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let provider;
        let signer;
        let contracts = {};
        let isConnected = false;
        
        // Direcciones de contratos
        const CONTRACT_ADDRESSES = {
            KOQUI_COIN: "0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9",
            TICKET_NFT: "0x0165878A594ca255338adfa4d48449f69242Eb8F"
        };
        
        // ABIs
        const KOQUI_COIN_ABI = [
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function mint(address to, uint256 amount) external",
            "function burn(uint256 amount) external"
        ];
        
        const TICKET_NFT_ABI = [
            "function totalSupply() view returns (uint256)"
        ];
        
        function log(message, type = 'info') {
            console.log(message);
            const logEl = document.getElementById('activityLog');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${time}] ${message}`;
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
            
            // Tambi√©n mostrar en debug info
            const debugEl = document.getElementById('debugInfo');
            debugEl.innerHTML += `${message}\\n`;
            debugEl.scrollTop = debugEl.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('connectionDetails');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }
        
        function updateConnectionIndicator(status, text) {
            const indicator = document.getElementById('connectionStatus');
            indicator.className = `connection-status ${status}`;
            indicator.textContent = text;
        }
        
        async function testStep1_BasicConnection() {
            log("üîç PASO 1: Probando conexi√≥n b√°sica...");
            updateStatus("Probando conexi√≥n a localhost:8545...", "loading");
            
            try {
                // Crear provider con timeout
                provider = new ethers.providers.JsonRpcProvider({
                    url: "http://localhost:8545",
                    timeout: 5000
                });
                
                log("‚úÖ Provider creado correctamente");
                
                // Test de red
                const network = await provider.getNetwork();
                log(`‚úÖ Red detectada: Chain ID ${network.chainId}`);
                document.getElementById('networkStatus').textContent = `Chain ${network.chainId}`;
                
                return true;
                
            } catch (error) {
                log(`‚ùå Error en conexi√≥n b√°sica: ${error.message}`);
                updateStatus(`Error de conexi√≥n: ${error.message}`, "error");
                updateConnectionIndicator("disconnected", "üî¥ Error de Red");
                return false;
            }
        }
        
        async function testStep2_GetAccounts() {
            log("üîç PASO 2: Obteniendo cuentas...");
            
            try {
                const accounts = await provider.listAccounts();
                log(`‚úÖ Encontradas ${accounts.length} cuentas`);
                document.getElementById('accountCount').textContent = accounts.length;
                
                if (accounts.length === 0) {
                    throw new Error('No hay cuentas disponibles');
                }
                
                // Usar primera cuenta
                signer = provider.getSigner(accounts[0]);
                const address = await signer.getAddress();
                log(`‚úÖ Usando cuenta: ${address}`);
                document.getElementById('activeAddress').textContent = 
                    address.substring(0, 6) + '...' + address.substring(38);
                
                // Obtener balance
                const balance = await provider.getBalance(address);
                const ethBalance = ethers.utils.formatEther(balance);
                log(`‚úÖ Balance: ${ethBalance} ETH`);
                document.getElementById('ethBalance').textContent = `${parseFloat(ethBalance).toFixed(2)} ETH`;
                
                return true;
                
            } catch (error) {
                log(`‚ùå Error obteniendo cuentas: ${error.message}`);
                updateStatus(`Error con cuentas: ${error.message}`, "error");
                return false;
            }
        }
        
        async function testStep3_TestContracts() {
            log("üîç PASO 3: Probando contratos...");
            
            try {
                // Crear instancias de contratos
                contracts.koquiCoin = new ethers.Contract(
                    CONTRACT_ADDRESSES.KOQUI_COIN, 
                    KOQUI_COIN_ABI, 
                    signer
                );
                
                contracts.ticketNFT = new ethers.Contract(
                    CONTRACT_ADDRESSES.TICKET_NFT, 
                    TICKET_NFT_ABI, 
                    signer
                );
                
                log("‚úÖ Contratos instanciados");
                
                // Probar llamadas
                const totalSupply = await contracts.koquiCoin.totalSupply();
                const userAddress = await signer.getAddress();
                const balance = await contracts.koquiCoin.balanceOf(userAddress);
                const totalTickets = await contracts.ticketNFT.totalSupply();
                
                log(`‚úÖ Total Supply: ${ethers.utils.formatEther(totalSupply)} KOQUI`);
                log(`‚úÖ Tu Balance: ${ethers.utils.formatEther(balance)} KOQUI`);
                log(`‚úÖ Total Tickets: ${totalTickets}`);
                
                // Actualizar UI
                document.getElementById('totalSupply').textContent = 
                    parseFloat(ethers.utils.formatEther(totalSupply)).toLocaleString() + ' KOQUI';
                document.getElementById('userBalance').textContent = 
                    parseFloat(ethers.utils.formatEther(balance)).toLocaleString() + ' KOQUI';
                document.getElementById('totalTickets').textContent = totalTickets.toString();
                
                // Mostrar secciones
                document.getElementById('contractSection').style.display = 'block';
                document.getElementById('actionsSection').style.display = 'block';
                
                return true;
                
            } catch (error) {
                log(`‚ùå Error con contratos: ${error.message}`);
                updateStatus(`Error con contratos: ${error.message}`, "error");
                return false;
            }
        }
        
        async function init() {
            log("üöÄ Iniciando diagn√≥stico completo...");
            updateConnectionIndicator("testing", "üîÑ Diagnosticando...");
            
            // Paso 1: Conexi√≥n b√°sica
            const step1 = await testStep1_BasicConnection();
            if (!step1) return;
            
            // Paso 2: Cuentas
            const step2 = await testStep2_GetAccounts();
            if (!step2) return;
            
            // Paso 3: Contratos
            const step3 = await testStep3_TestContracts();
            if (!step3) return;
            
            // √âxito total
            log("üéâ ¬°CONEXI√ìN EXITOSA!");
            updateStatus("¬°Conectado exitosamente a KoquiFI!", "success");
            updateConnectionIndicator("connected", "üü¢ Conectado");
            isConnected = true;
        }
        
        async function mintTokens() {
            if (!isConnected) {
                alert('No est√°s conectado');
                return;
            }
            
            try {
                const amount = document.getElementById('mintAmount').value;
                if (!amount || amount <= 0) {
                    throw new Error('Cantidad inv√°lida');
                }
                
                const statusEl = document.getElementById('actionStatus');
                statusEl.textContent = '‚è≥ Minteando...';
                statusEl.className = 'status-message loading';
                statusEl.style.display = 'block';
                
                const address = await signer.getAddress();
                const tx = await contracts.koquiCoin.mint(address, ethers.utils.parseEther(amount));
                
                log(`‚è≥ Transacci√≥n enviada: ${tx.hash}`);
                
                await tx.wait();
                
                log(`‚úÖ Mint exitoso: ${amount} KOQUI`);
                statusEl.textContent = `‚úÖ ${amount} KOQUI minteados!`;
                statusEl.className = 'status-message success';
                
                // Actualizar stats
                setTimeout(testStep3_TestContracts, 1000);
                
            } catch (error) {
                log(`‚ùå Error en mint: ${error.message}`);
                const statusEl = document.getElementById('actionStatus');
                statusEl.textContent = `‚ùå Error: ${error.message}`;
                statusEl.className = 'status-message error';
                statusEl.style.display = 'block';
            }
        }
        
        async function burnTokens() {
            if (!isConnected) {
                alert('No est√°s conectado');
                return;
            }
            
            try {
                const amount = document.getElementById('mintAmount').value;
                if (!amount || amount <= 0) {
                    throw new Error('Cantidad inv√°lida');
                }
                
                const statusEl = document.getElementById('actionStatus');
                statusEl.textContent = '‚è≥ Quemando...';
                statusEl.className = 'status-message loading';
                statusEl.style.display = 'block';
                
                const tx = await contracts.koquiCoin.burn(ethers.utils.parseEther(amount));
                
                log(`‚è≥ Transacci√≥n enviada: ${tx.hash}`);
                
                await tx.wait();
                
                log(`‚úÖ Burn exitoso: ${amount} KOQUI`);
                statusEl.textContent = `‚úÖ ${amount} KOQUI quemados!`;
                statusEl.className = 'status-message success';
                
                // Actualizar stats
                setTimeout(testStep3_TestContracts, 1000);
                
            } catch (error) {
                log(`‚ùå Error en burn: ${error.message}`);
                const statusEl = document.getElementById('actionStatus');
                statusEl.textContent = `‚ùå Error: ${error.message}`;
                statusEl.className = 'status-message error';
                statusEl.style.display = 'block';
            }
        }
        
        // Iniciar cuando se carga la p√°gina
        window.addEventListener('load', () => {
            setTimeout(init, 500);
        });
        
        // Auto-refresh cada 30 segundos si est√° conectado
        setInterval(() => {
            if (isConnected) {
                testStep3_TestContracts();
            }
        }, 30000);
    </script>
</body>
</html>
