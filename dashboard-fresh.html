<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KoquiFI Dashboard - Fresh Deployment</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.6.9.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .status {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e53e3e;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #38a169;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-content {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .card {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .activity-log {
            grid-column: 1 / -1;
            background: #2d3748;
            color: white;
            border-radius: 15px;
            padding: 25px;
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-log h3 {
            color: white;
            margin-bottom: 15px;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #4a5568;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #a0aec0;
            margin-right: 10px;
        }

        .addresses-card {
            grid-column: 1 / -1;
            background: #edf2f7;
            border: 2px solid #e2e8f0;
        }

        .address-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .address-label {
            font-weight: 600;
            color: #2d3748;
        }

        .address-value {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .test-section {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
        }

        .error {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .success {
            background: #c6f6d5;
            border: 1px solid #68d391;
            color: #2f855a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>🥥 KoquiFI DeFi Platform</h1>
            <h2>Fresh Deployment Dashboard</h2>
            <div class="status">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="statusText">Desconectado</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Direcciones de Contratos -->
            <div class="card addresses-card">
                <h3>📋 Direcciones de Contratos Deployados</h3>
                <div class="address-item">
                    <span class="address-label">🪙 KoquiCoin:</span>
                    <span class="address-value">0x5FbDB2315678afecb367f032d93F642f64180aa3</span>
                </div>
                <div class="address-item">
                    <span class="address-label">🎫 KoquiTicketNFT:</span>
                    <span class="address-value">0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0</span>
                </div>
                <div class="address-item">
                    <span class="address-label">🎰 KoquiStaking:</span>
                    <span class="address-value">0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9</span>
                </div>
                <div class="address-item">
                    <span class="address-label">💱 KoquiDEX:</span>
                    <span class="address-value">0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9</span>
                </div>
                <div class="address-item">
                    <span class="address-label">📊 KoquiPriceOracle:</span>
                    <span class="address-value">0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="card">
                <h3>📊 Estadísticas de Red</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="blockNumber">-</div>
                        <div class="stat-label">Bloque Actual</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gasPrice">-</div>
                        <div class="stat-label">Gas Price (Gwei)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="networkId">-</div>
                        <div class="stat-label">Network ID</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accountBalance">-</div>
                        <div class="stat-label">Balance (ETH)</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshStats()">🔄 Actualizar Stats</button>
            </div>

            <!-- Token Stats -->
            <div class="card">
                <h3>🪙 KoquiCoin Stats</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalSupply">-</div>
                        <div class="stat-label">Supply Total</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="userBalance">-</div>
                        <div class="stat-label">Tu Balance</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="decimals">-</div>
                        <div class="stat-label">Decimales</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="tokenSymbol">-</div>
                        <div class="stat-label">Símbolo</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshTokenStats()">🔄 Actualizar Token</button>
            </div>

            <!-- Testing Section -->
            <div class="card test-section">
                <h3>🧪 Testing de Contratos</h3>
                
                <div class="input-group">
                    <label>💰 Mint KOQUI Tokens</label>
                    <input type="text" id="mintAmount" placeholder="Cantidad (ej: 1000)" value="1000">
                    <button class="btn" onclick="mintTokens()">🏦 Mint Tokens</button>
                </div>

                <div class="input-group">
                    <label>🔥 Burn KOQUI Tokens</label>
                    <input type="text" id="burnAmount" placeholder="Cantidad a quemar" value="100">
                    <button class="btn" onclick="burnTokens()">🔥 Burn Tokens</button>
                </div>

                <div class="input-group">
                    <label>🎫 Mint Ticket NFT</label>
                    <input type="text" id="ticketNumbers" placeholder="Números: 1,2,3,4,5" value="1,2,3,4,5">
                    <button class="btn" onclick="mintTicket()">🎫 Mint Ticket</button>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="activity-log">
                <h3>📈 Log de Actividades</h3>
                <div id="activityLog">
                    <div class="log-entry">
                        <span class="log-timestamp">[Iniciando...]</span>
                        <span>Dashboard iniciado, conectando a blockchain...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract addresses from fresh deployment
        const CONTRACT_ADDRESSES = {
            KoquiCoin: "0x5FbDB2315678afecb367f032d93F642f64180aa3",
            KoquiTicketNFT: "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0",
            KoquiStaking: "0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9",
            KoquiDEX: "0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9",
            KoquiPriceOracle: "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
        };

        // ABIs simplificados
        const KOQUI_COIN_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function mint(address to, uint256 amount)",
            "function burn(uint256 amount)",
            "function grantRole(bytes32 role, address account)"
        ];

        const TICKET_NFT_ABI = [
            "function mintTicket(address to, uint8[5] numbers, uint256 weekNumber, uint256 ticketPrice)",
            "function balanceOf(address owner) view returns (uint256)",
            "function ownerOf(uint256 tokenId) view returns (address)"
        ];

        let provider;
        let signer;
        let koquiCoin;
        let ticketNFT;
        let currentAccount;

        // Initialize
        async function init() {
            try {
                addLog("🔌 Intentando conectar a Hardhat local...");
                
                if (typeof ethers === 'undefined') {
                    throw new Error('ethers.js no está cargado');
                }

                // Connect to local Hardhat node
                provider = new ethers.providers.JsonRpcProvider("http://localhost:8545");
                
                // Test connection
                const network = await provider.getNetwork();
                addLog(`✅ Conectado a red: ${network.name} (chainId: ${network.chainId})`);
                
                // Get signer
                signer = provider.getSigner(0);
                currentAccount = await signer.getAddress();
                addLog(`👤 Cuenta activa: ${currentAccount}`);

                // Initialize contracts
                koquiCoin = new ethers.Contract(CONTRACT_ADDRESSES.KoquiCoin, KOQUI_COIN_ABI, signer);
                ticketNFT = new ethers.Contract(CONTRACT_ADDRESSES.KoquiTicketNFT, TICKET_NFT_ABI, signer);

                // Update UI
                updateConnectionStatus(true);
                refreshStats();
                refreshTokenStats();

                addLog("🎉 Dashboard completamente conectado y listo!");

            } catch (error) {
                console.error('Error al inicializar:', error);
                addLog(`❌ Error de conexión: ${error.message}`);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Conectado a Hardhat';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Desconectado';
            }
        }

        async function refreshStats() {
            try {
                const blockNumber = await provider.getBlockNumber();
                const gasPrice = await provider.getGasPrice();
                const network = await provider.getNetwork();
                const balance = await provider.getBalance(currentAccount);

                document.getElementById('blockNumber').textContent = blockNumber;
                document.getElementById('gasPrice').textContent = ethers.utils.formatUnits(gasPrice, 'gwei').slice(0, 6);
                document.getElementById('networkId').textContent = network.chainId;
                document.getElementById('accountBalance').textContent = ethers.utils.formatEther(balance).slice(0, 8);

                addLog("📊 Stats de red actualizadas");
            } catch (error) {
                addLog(`❌ Error al actualizar stats: ${error.message}`);
            }
        }

        async function refreshTokenStats() {
            try {
                const totalSupply = await koquiCoin.totalSupply();
                const userBalance = await koquiCoin.balanceOf(currentAccount);
                const decimals = await koquiCoin.decimals();
                const symbol = await koquiCoin.symbol();

                document.getElementById('totalSupply').textContent = ethers.utils.formatEther(totalSupply).slice(0, 10);
                document.getElementById('userBalance').textContent = ethers.utils.formatEther(userBalance).slice(0, 10);
                document.getElementById('decimals').textContent = decimals;
                document.getElementById('tokenSymbol').textContent = symbol;

                addLog("🪙 Stats de token actualizadas");
            } catch (error) {
                addLog(`❌ Error al obtener stats de token: ${error.message}`);
            }
        }

        async function mintTokens() {
            try {
                const amount = document.getElementById('mintAmount').value;
                if (!amount) {
                    addLog("❌ Ingresa una cantidad para mint");
                    return;
                }

                addLog(`🏦 Minteando ${amount} KOQUI tokens...`);
                const tx = await koquiCoin.mint(currentAccount, ethers.utils.parseEther(amount));
                addLog(`⏳ Transacción enviada: ${tx.hash}`);
                
                await tx.wait();
                addLog(`✅ ¡${amount} KOQUI tokens minteados exitosamente!`);
                
                refreshTokenStats();
            } catch (error) {
                addLog(`❌ Error al mintear: ${error.message}`);
            }
        }

        async function burnTokens() {
            try {
                const amount = document.getElementById('burnAmount').value;
                if (!amount) {
                    addLog("❌ Ingresa una cantidad para quemar");
                    return;
                }

                addLog(`🔥 Quemando ${amount} KOQUI tokens...`);
                const tx = await koquiCoin.burn(ethers.utils.parseEther(amount));
                addLog(`⏳ Transacción enviada: ${tx.hash}`);
                
                await tx.wait();
                addLog(`✅ ¡${amount} KOQUI tokens quemados exitosamente!`);
                
                refreshTokenStats();
            } catch (error) {
                addLog(`❌ Error al quemar: ${error.message}`);
            }
        }

        async function mintTicket() {
            try {
                const numbersInput = document.getElementById('ticketNumbers').value;
                const numbers = numbersInput.split(',').map(n => parseInt(n.trim()));
                
                if (numbers.length !== 5) {
                    addLog("❌ Debes ingresar exactamente 5 números");
                    return;
                }

                addLog(`🎫 Minteando ticket NFT con números: [${numbers.join(', ')}]...`);
                const tx = await ticketNFT.mintTicket(
                    currentAccount, 
                    numbers, 
                    1, // Week number
                    ethers.utils.parseEther("10") // Ticket price
                );
                addLog(`⏳ Transacción enviada: ${tx.hash}`);
                
                await tx.wait();
                addLog(`✅ ¡Ticket NFT minteado exitosamente!`);
                
            } catch (error) {
                addLog(`❌ Error al mintear ticket: ${error.message}`);
            }
        }

        function addLog(message) {
            const logContainer = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span>${message}</span>`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
